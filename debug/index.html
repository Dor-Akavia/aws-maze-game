<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maze Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stat { text-align: center; }
        .stat-label { font-size: 0.8em; color: #666; }
        .stat-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        
        #gameCanvas {
            display: block;
            margin: 0 auto 20px;
            border: 3px solid #667eea;
            border-radius: 10px;
            max-width: 100%;
            height: auto;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(3, 80px);
            grid-gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .btn-control {
            height: 80px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .btn-control:active { transform: scale(0.95); }
        .btn-up { grid-column: 2; grid-row: 1; }
        .btn-left { grid-column: 1; grid-row: 2; }
        .btn-right { grid-column: 3; grid-row: 2; }
        .btn-down { grid-column: 2; grid-row: 3; }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 90%;
        }
        
        .modal-title { font-size: 2em; color: #667eea; margin-bottom: 20px; }
        
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 20px;
            user-select: none;
        }
        
        .btn-primary:active { transform: scale(0.95); }
        
        .loading { text-align: center; padding: 40px; color: #667eea; }
        .error { background: #ffe6e6; color: #e74c3c; padding: 20px; border-radius: 10px; margin: 20px 0; }
        
        .hint { text-align: center; color: #999; font-size: 0.9em; margin-top: 10px; }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            .controls { grid-template-columns: repeat(3, 70px); }
            .btn-control { height: 70px; font-size: 1.5em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Maze Game</h1>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">Stage</div>
                <div class="stat-value" id="stage">1/10</div>
            </div>
            <div class="stat">
                <div class="stat-label">Moves</div>
                <div class="stat-value" id="moves">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">Time</div>
                <div class="stat-value" id="time">0.0s</div>
            </div>
        </div>
        
        <div id="loading" class="loading">Loading maze...</div>
        <div id="error" class="error" style="display:none;"></div>
        
        <canvas id="gameCanvas" width="800" height="600" style="display:none;"></canvas>
        
        <div class="controls">
            <button class="btn-control btn-up" ontouchstart="move('up')" onclick="move('up')">‚Üë</button>
            <button class="btn-control btn-left" ontouchstart="move('left')" onclick="move('left')">‚Üê</button>
            <button class="btn-control btn-right" ontouchstart="move('right')" onclick="move('right')">‚Üí</button>
            <button class="btn-control btn-down" ontouchstart="move('down')" onclick="move('down')">‚Üì</button>
        </div>
        
        <p class="hint">Tap buttons or use keyboard arrows</p>
    </div>
    
    <div id="stageModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üéâ Stage Complete!</div>
            <p id="stageMsg"></p>
            <button class="btn-primary" ontouchstart="nextStage()" onclick="nextStage()">Continue</button>
        </div>
    </div>
    
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üèÜ You Win!</div>
            <p id="gameMsg"></p>
            <button class="btn-primary" ontouchstart="restart()" onclick="restart()">Play Again</button>
        </div>
    </div>
    
    <script>
        // IMPORTANT: Replace this with your API Gateway URL
        const API_URL = 'https://2v7nwvlmwj.execute-api.eu-north-1.amazonaws.com/prod/level';
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let game = {
            stage: 1,
            maze: [],
            px: 0, py: 0,
            ex: 0, ey: 0,
            moves: 0,
            totalMoves: 0,
            startTime: 0,
            gameStartTime: 0,
            playing: false
        };
        
        async function loadStage(n) {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                canvas.style.display = 'none';
                
                const res = await fetch(API_URL + '/' + n);
                const data = await res.json();
                
                if (!data.success) throw new Error(data.error);
                
                const d = data.data;
                game.maze = d.layout.split('\n').map(r => r.split(''));
                game.px = d.start_x;
                game.py = d.start_y;
                game.ex = d.end_x;
                game.ey = d.end_y;
                game.stage = n;
                game.moves = 0;
                game.startTime = Date.now();
                game.playing = true;
                
                document.getElementById('stage').textContent = n + '/10';
                document.getElementById('moves').textContent = '0';
                document.getElementById('loading').style.display = 'none';
                canvas.style.display = 'block';
                
                draw();
            } catch(e) {
                document.getElementById('error').textContent = 'Error: ' + e.message;
                document.getElementById('error').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function draw() {
            const cell = 30;
            canvas.width = game.maze[0].length * cell;
            canvas.height = game.maze.length * cell;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            for (let y = 0; y < game.maze.length; y++) {
                for (let x = 0; x < game.maze[y].length; x++) {
                    const px = x * cell;
                    const py = y * cell;
                    
                    if (game.maze[y][x] === '#') {
                        ctx.fillStyle = '#2c3e50';
                        ctx.fillRect(px, py, cell, cell);
                    } else {
                        ctx.fillStyle = '#ecf0f1';
                        ctx.fillRect(px, py, cell, cell);
                    }
                    
                    ctx.strokeStyle = '#bdc3c7';
                    ctx.strokeRect(px, py, cell, cell);
                    
                    if (x === game.ex && y === game.ey) {
                        ctx.fillStyle = '#2ecc71';
                        ctx.fillRect(px, py, cell, cell);
                    }
                }
            }
            
            ctx.fillStyle = '#3498db';
            ctx.beginPath();
            ctx.arc(game.px * cell + cell/2, game.py * cell + cell/2, cell/3, 0, Math.PI * 2);
            ctx.fill();
        }
        
        function move(dir) {
            if (!game.playing) return;
            
            let nx = game.px, ny = game.py;
            if (dir === 'up') ny--;
            if (dir === 'down') ny++;
            if (dir === 'left') nx--;
            if (dir === 'right') nx++;
            
            if (ny < 0 || ny >= game.maze.length) return;
            if (nx < 0 || nx >= game.maze[ny].length) return;
            if (game.maze[ny][nx] === '#') return;
            
            game.px = nx;
            game.py = ny;
            game.moves++;
            game.totalMoves++;
            
            document.getElementById('moves').textContent = game.moves;
            draw();
            
            if (nx === game.ex && ny === game.ey) {
                game.playing = false;
                const time = ((Date.now() - game.startTime) / 1000).toFixed(1);
                
                if (game.stage >= 10) {
                    const total = ((Date.now() - game.gameStartTime) / 1000).toFixed(1);
                    document.getElementById('gameMsg').innerHTML = 
                        'All 10 stages completed!<br><br>Time: ' + total + 's<br>Moves: ' + game.totalMoves;
                    document.getElementById('gameModal').classList.add('active');
                } else {
                    document.getElementById('stageMsg').innerHTML = 
                        'Stage ' + game.stage + ' complete!<br>Time: ' + time + 's | Moves: ' + game.moves;
                    document.getElementById('stageModal').classList.add('active');
                }
            }
        }
        
        function nextStage() {
            document.getElementById('stageModal').classList.remove('active');
            loadStage(game.stage + 1);
        }
        
        function restart() {
            document.getElementById('gameModal').classList.remove('active');
            game.totalMoves = 0;
            game.gameStartTime = Date.now();
            loadStage(1);
        }
        
        // Keyboard controls (for desktop)
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowUp') { move('up'); e.preventDefault(); }
            if (e.key === 'ArrowDown') { move('down'); e.preventDefault(); }
            if (e.key === 'ArrowLeft') { move('left'); e.preventDefault(); }
            if (e.key === 'ArrowRight') { move('right'); e.preventDefault(); }
        });
        
        // Prevent double-tap zoom on mobile
        let lastTouchEnd = 0;
        document.addEventListener('touchend', e => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Timer
        setInterval(() => {
            if (game.playing) {
                const t = ((Date.now() - game.startTime) / 1000).toFixed(1);
                document.getElementById('time').textContent = t + 's';
            }
        }, 100);
        
        // Start
        game.gameStartTime = Date.now();
        loadStage(1);
    </script>
</body>
</html>
